{% extends 'tracker/base.html' %}
{% load static %}

{% block title %}Dashboard - Campus Issue Tracker{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
    <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <div class="bg-primary text-white rounded-circle p-2 me-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-geo-alt-fill" viewBox="0 0 16 16">
                    <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                </svg>
            </div>
            <div>
                <div class="fw-bold">Campus Issue Tracker</div>
                <small class="text-muted" style="font-size: 0.8em;">Report & Track Issues</small>
            </div>
        </a>
        
        <div class="ms-auto d-flex align-items-center">
            <a href="{% url 'dashboard' %}" class="btn btn-light me-2 d-flex align-items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grid-fill me-2" viewBox="0 0 16 16"><path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zm8 0A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm-8 8A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm8 0A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3z"/></svg>
                Dashboard
            </a>
            <a href="{% url 'report_issue' %}" class="btn btn-primary me-3">Report Issue</a>
            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <span class="fw-bold">J</span>
            </div>
        </div>
    </div>
</nav>

<main class="container-fluid p-4">
    <div class="mb-4">
        <h1 class="h3 fw-bold">Campus Issues Dashboard</h1>
        <p class="text-muted">Track and manage campus maintenance issues in real-time</p>
    </div>

    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 py-2">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs fw-bold text-uppercase mb-1">Total Issues</div>
                        <div class="h5 mb-0 fw-bold text-gray-800">{{ total_issue_count }}</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-graph-up-arrow text-primary" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M0 0h1v15h15v1H0V0Zm10 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0V4.9l-3.613 4.417a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61L13.445 4H10.5a.5.5 0 0 1-.5-.5Z"/></svg>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4"><div class="card border-0 shadow-sm h-100 py-2"><div class="card-body d-flex justify-content-between align-items-center"><div><div class="text-xs fw-bold text-uppercase mb-1">Reported</div><div class="h5 mb-0 fw-bold text-danger">{{ reported_count }}</div></div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-circle text-danger" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/></svg></div></div></div>
        <div class="col-xl-3 col-md-6 mb-4"><div class="card border-0 shadow-sm h-100 py-2"><div class="card-body d-flex justify-content-between align-items-center"><div><div class="text-xs fw-bold text-uppercase mb-1">In Progress</div><div class="h5 mb-0 fw-bold text-primary">{{ in_progress_count }}</div></div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-clock-history text-primary" viewBox="0 0 16 16"><path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.272zm.832 1.29a6.99 6.99 0 0 0-.343-.273l.662-.74c.258.227.504.468.738.718l-.545.835a6.996 6.996 0 0 0-.254-.183zM8.5 5.5a.5.5 0 0 0-1 0v3.362l-1.429 2.38a.5.5 0 1 0 .858.515l1.5-2.5A.5.5 0 0 0 8.5 9V5.5z"/><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-6.252 10.658l.063.07A7 7 0 0 0 8 15a7 7 0 0 0 6.313-4.342l.063-.07A7 7 0 0 0 8 1z"/></svg></div></div></div>
        <div class="col-xl-3 col-md-6 mb-4"><div class="card border-0 shadow-sm h-100 py-2"><div class="card-body d-flex justify-content-between align-items-center"><div><div class="text-xs fw-bold text-uppercase mb-1">Resolved</div><div class="h5 mb-0 fw-bold text-success">{{ resolved_count }}</div></div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-check-circle text-success" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/></svg></div></div></div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <form method="GET" action="{% url 'dashboard' %}">
            <div class="card-body d-flex flex-wrap justify-content-between align-items-center">
                
                <div class="btn-group me-3 mb-2 mb-md-0" role="group">
                    <button type="button" class="btn btn-primary">List View</button>
                    <button type="button" class="btn btn-outline-secondary">Map View</button>
                </div>

                <div class="d-flex flex-wrap align-items-end">
                    <div class="me-3 mb-2 mb-md-0">
                        <label for="category" class="form-label small text-muted">Filter by Category</label>
                        <select class="form-select" id="category" name="category">
                            <option value="ALL">All</option>
                            {% for value, display_name in category_choices %}
                                <option value="{{ value }}" {% if selected_category == value %}selected{% endif %}>
                                    {{ display_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="me-3 mb-2 mb-md-0">
                        <label for="status" class="form-label small text-muted">Filter by Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="ALL">All</option>
                            {% for value, display_name in status_choices %}
                                <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>
                                    {{ display_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="me-3 mb-2 mb-md-0">
                        <label for="sort" class="form-label small text-muted">Sort by</label>
                        <select class="form-select" id="sort" name="sort_by">
                            <option value="most_recent" {% if selected_sort_by == 'most_recent' %}selected{% endif %}>Most Recent</option>
                            <option value="most_voted" {% if selected_sort_by == 'most_voted' %}selected{% endif %}>Most Voted</option>
                        </select>
                    </div>
                    
                    <div class="mb-2 mb-md-0">
                        <button type="submit" class="btn btn-secondary">Apply</button>
                    </div>
                </div>

            </div>
        </form>
    </div>

    {% for issue in issues %}
        <a href="{% url 'issue_detail' issue.id %}" class="text-decoration-none text-dark mb-3 d-block">
            <div class="card border-0 shadow-sm issue-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title fw-bold">{{ issue.title }}</h5>
                            <p class="card-subtitle text-muted small">
                                <span>{{ issue.get_building_display }}</span> &bull;
                                
                                <span class="badge mb-2 
                                    {% if issue.status == 'REPORTED' %} bg-danger 
                                    {% elif issue.status == 'IN_PROGRESS' %} bg-warning text-dark 
                                    {% elif issue.status == 'RESOLVED' %} bg-success 
                                    {% else %} bg-secondary 
                                    {% endif %}">
                                    {{ issue.get_status_display }}
                                </span> &bull;
                                
                                <span>Reported on {{ issue.created_at|date:"m/d/Y" }}</span> &bull;
                                
                                <span>by {{ issue.report.username }}</span>
                            </p>
                        </div>
                        <div class="d-flex flex-column align-items-center ms-4">
                            <span class="badge mb-2 
                                {% if issue.status == 'REPORTED' %} bg-danger 
                                {% elif issue.status == 'IN_PROGRESS' %} bg-warning text-dark 
                                {% elif issue.status == 'RESOLVED' %} bg-success 
                                {% else %} bg-secondary 
                                {% endif %}">
                                {{ issue.get_status_display }}
                            </span>
                            
                            <a href="{% url 'vote_issue' issue.id %}" 
                                class="btn btn-light border d-flex flex-column align-items-center p-2 vote-button" 
                                data-issue-id="{{ issue.id }}">
                             
                                <span>▲</span>
                             
                                <span class="fw-bold vote-count-{{ issue.id }}">{{ issue.votes.count }}</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    
    {% empty %}
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <p class="text-muted">No issues have been reported yet. Be the first!</p>
            </div>
        </div>
    {% endfor %}
</main>
{% endblock %}